<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Share Viewer - Embedded</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .embed-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: #000;
        }

        .video-container {
            width: 100%;
            height: 100%;
            background: #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .video-container canvas {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .video-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 40px;
            width: 100%;
            height: 100%;
        }

        .video-placeholder i {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .video-placeholder h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #fff;
        }

        .video-placeholder p {
            font-size: 1rem;
            color: #aaa;
            line-height: 1.6;
        }

        #firebaseStatus {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            color: #ff9800;
            max-width: 500px;
        }

        #firebaseStatus code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .status-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 25px;
            color: white;
            font-size: 0.9rem;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator.waiting {
            color: #ff9800;
        }

        .status-indicator.connected {
            color: #4CAF50;
        }

        .status-indicator.connected::before {
            content: 'ðŸ”´ ';
            animation: pulse 2s infinite;
        }

        .live-badge {
            display: inline-block;
            background: #e74c3c;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Hide status indicator when streaming */
        .embed-container.streaming .status-indicator {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="embed-container" id="embedContainer">
        <div class="video-container" id="videoContainer">
            <video id="viewVideo" autoplay playsinline style="display: none;"></video>
            <div id="videoPlaceholder" class="video-placeholder">
                <i class="fas fa-video"></i>
                <h3 id="placeholderTitle">Waiting for video stream...</h3>
                <p id="placeholderMessage">Please start sharing on the main page</p>
                <div id="firebaseStatus" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Firebase Not Configured</strong>
                    <p style="margin-top: 10px; font-size: 0.9rem;">To view from other devices, please configure Firebase in <code>firebase-config.js</code></p>
                </div>
            </div>
        </div>
        <div class="status-indicator waiting" id="statusIndicator">
            <i class="fas fa-circle"></i>
            <span id="statusText">Waiting for connection...</span>
        </div>
    </div>

    <script>
        class VideoViewer {
            constructor() {
                this.viewVideo = document.getElementById('viewVideo');
                this.videoPlaceholder = document.getElementById('videoPlaceholder');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.statusText = document.getElementById('statusText');
                this.embedContainer = document.getElementById('embedContainer');
                this.canvas = null;
                this.ctx = null;
                this.isStreaming = false;
                this.lastFrameTime = 0;
                this.frameBuffer = [];
                this.isPlaying = false;
                this.playbackInterval = null;
                this.db = null;
                this.frameRef = null;
                this.statusRef = null;
                
                // Try to initialize Firebase, fallback to BroadcastChannel if not available
                this.initFirebase();
                this.init();
            }

            initFirebase() {
                try {
                    // Check if Firebase is available and configured
                    if (typeof firebase !== 'undefined' && typeof FIREBASE_CONFIG !== 'undefined' && isFirebaseConfigured()) {
                        // Initialize Firebase only if not already initialized
                        if (!firebase.apps || firebase.apps.length === 0) {
                            firebase.initializeApp(FIREBASE_CONFIG);
                        }
                        this.db = firebase.database();
                        this.useFirebase = true;
                        console.log('Firebase initialized for cross-device viewing');
                        
                        // Test Firebase connection
                        this.testFirebaseConnection();
                    } else {
                        if (typeof firebase === 'undefined') {
                            console.log('Firebase SDK not loaded, using BroadcastChannel fallback');
                            this.showFirebaseWarning('Firebase SDK not loaded');
                        } else if (!isFirebaseConfigured()) {
                            console.log('Firebase not configured. Update firebase-config.js to enable cross-device viewing');
                            this.showFirebaseWarning('Firebase not configured');
                        }
                        this.useFirebase = false;
                        this.channel = new BroadcastChannel('screen-share-channel');
                    }
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    this.showFirebaseWarning('Firebase initialization failed');
                    this.useFirebase = false;
                    this.channel = new BroadcastChannel('screen-share-channel');
                }
            }

            showFirebaseWarning(reason) {
                const statusDiv = document.getElementById('firebaseStatus');
                const placeholderTitle = document.getElementById('placeholderTitle');
                const placeholderMessage = document.getElementById('placeholderMessage');
                
                if (statusDiv && placeholderTitle && placeholderMessage) {
                    statusDiv.style.display = 'block';
                    placeholderTitle.textContent = 'Cross-Device Viewing Unavailable';
                    placeholderMessage.innerHTML = `
                        <strong>Issue:</strong> ${reason}<br>
                        <strong>Solution:</strong> Configure Firebase to enable viewing from any device.<br>
                        <small>See FIREBASE_SETUP.md for instructions</small>
                    `;
                }
            }

            testFirebaseConnection() {
                if (!this.db) return;
                
                // Test connection by trying to read
                const testRef = this.db.ref('screenShare');
                testRef.once('value')
                    .then(() => {
                        console.log('Firebase connection successful');
                        this.updateStatus('waiting', 'Firebase connected - Waiting for stream...');
                    })
                    .catch((error) => {
                        console.error('Firebase connection failed:', error);
                        this.showFirebaseWarning(`Firebase connection error: ${error.message}`);
                        this.updateStatus('waiting', 'Firebase connection failed');
                    });
            }

            init() {
                // Create canvas for displaying frames
                this.canvas = document.createElement('canvas');
                this.canvas.style.position = 'absolute';
                this.canvas.style.top = '0';
                this.canvas.style.left = '0';
                this.canvas.style.width = '100%';
                this.canvas.style.height = '100%';
                this.canvas.style.objectFit = 'contain';
                this.ctx = this.canvas.getContext('2d');
                
                const videoContainer = document.getElementById('videoContainer');
                videoContainer.appendChild(this.canvas);
                this.canvas.style.display = 'none';
                
                if (this.useFirebase && this.db) {
                    this.setupFirebaseListeners();
                } else {
                    this.setupBroadcastChannelListeners();
                }

                this.checkForStream();
                this.updateStatus('waiting', 'Waiting for video stream...');
            }

            setupFirebaseListeners() {
                try {
                    // Listen for frame updates
                    this.frameRef = this.db.ref('screenShare/frame');
                    this.frameRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data && data.frameData) {
                            this.handleFrame({ data: data.frameData, timestamp: data.timestamp });
                        } else {
                            // No data means stream hasn't started or was cleared
                            if (this.isStreaming) {
                                // Stream was active but frames stopped coming
                                console.log('Frames stopped receiving');
                            }
                        }
                    }, (error) => {
                        console.error('Firebase frame listener error:', error);
                        this.showFirebaseWarning(`Database error: ${error.message}`);
                    });

                    // Listen for status updates
                    this.statusRef = this.db.ref('screenShare/status');
                    this.statusRef.on('value', (snapshot) => {
                        const status = snapshot.val();
                        if (status) {
                            if (status.status === 'started') {
                                this.updateStatus('connected', 'Stream started - Waiting for frames...');
                                // Hide Firebase warning if stream starts
                                const statusDiv = document.getElementById('firebaseStatus');
                                if (statusDiv) statusDiv.style.display = 'none';
                            } else if (status.status === 'stopped') {
                                this.handleStreamStopped();
                            } else if (status.status === 'paused') {
                                this.handleStreamPaused();
                            } else if (status.status === 'resumed') {
                                this.handleStreamResumed();
                            }
                        } else {
                            // No status means sharing hasn't started
                            this.updateStatus('waiting', 'Waiting for screen sharing to start...');
                        }
                    }, (error) => {
                        console.error('Firebase status listener error:', error);
                        this.showFirebaseWarning(`Database error: ${error.message}`);
                    });
                } catch (error) {
                    console.error('Error setting up Firebase listeners:', error);
                    this.showFirebaseWarning(`Setup error: ${error.message}`);
                }
            }

            setupBroadcastChannelListeners() {
                // Fallback to BroadcastChannel for same-device viewing
                this.channel.onmessage = (event) => {
                    if (event.data.type === 'frame') {
                        this.handleFrame(event.data);
                    } else if (event.data.type === 'stream-update') {
                        this.handleStreamUpdate(event.data);
                    } else if (event.data.type === 'stream-stopped') {
                        this.handleStreamStopped();
                    } else if (event.data.type === 'stream-paused') {
                        this.handleStreamPaused();
                    } else if (event.data.type === 'stream-resumed') {
                        this.handleStreamResumed();
                    } else if (event.data.type === 'stream-status') {
                        if (event.data.status === 'started') {
                            this.updateStatus('connected', 'Connected - Streaming live');
                        }
                    }
                };
                this.channel.postMessage({ type: 'request-stream' });
            }

            checkForStream() {
                if (this.useFirebase && this.db) {
                    // Firebase mode - listeners will handle updates
                    this.updateStatus('waiting', 'Connected to Firebase - Waiting for stream...');
                } else {
                    // BroadcastChannel mode - only works on same device
                    const isSharing = localStorage.getItem('screen-sharing-active');
                    if (isSharing === 'true') {
                        this.updateStatus('waiting', 'Connecting to stream (same device only)...');
                    } else {
                        this.updateStatus('waiting', 'Waiting for stream... (Configure Firebase for cross-device)');
                    }
                }
            }

            handleFrame(data) {
                if (!this.isStreaming) {
                    this.isStreaming = true;
                    this.videoPlaceholder.style.display = 'none';
                    this.viewVideo.style.display = 'none';
                    this.canvas.style.display = 'block';
                    this.embedContainer.classList.add('streaming');
                    
                    // Hide Firebase warning once streaming starts
                    const statusDiv = document.getElementById('firebaseStatus');
                    if (statusDiv) statusDiv.style.display = 'none';
                    
                    this.updateStatus('connected', 'Live Streaming');
                    this.startSmoothPlayback();
                }

                // Add frame to buffer for smooth playback
                if (data && data.data) {
                    this.frameBuffer.push(data);
                    // Keep buffer size manageable (store last 3 frames for smoothness)
                    if (this.frameBuffer.length > 3) {
                        this.frameBuffer.shift();
                    }
                }
            }

            startSmoothPlayback() {
                if (this.playbackInterval) return;
                
                // Play frames at 30fps for smooth live stream feel
                this.playbackInterval = setInterval(() => {
                    if (this.frameBuffer.length > 0) {
                        const frameData = this.frameBuffer.shift();
                        this.displayFrame(frameData.data);
                    }
                }, 33); // ~30fps
            }

            displayFrame(frameData) {
                const img = new Image();
                img.onload = () => {
                    const container = this.canvas.parentElement;
                    const containerWidth = container.clientWidth;
                    const containerHeight = container.clientHeight;
                    
                    // Set canvas dimensions to match container
                    this.canvas.width = containerWidth;
                    this.canvas.height = containerHeight;
                    
                    // Calculate aspect-ratio preserving dimensions
                    const imgAspect = img.width / img.height;
                    const containerAspect = containerWidth / containerHeight;
                    
                    let drawWidth, drawHeight, drawX, drawY;
                    if (imgAspect > containerAspect) {
                        // Image is wider - fit to width
                        drawWidth = containerWidth;
                        drawHeight = containerWidth / imgAspect;
                        drawX = 0;
                        drawY = (containerHeight - drawHeight) / 2;
                    } else {
                        // Image is taller - fit to height
                        drawHeight = containerHeight;
                        drawWidth = containerHeight * imgAspect;
                        drawX = (containerWidth - drawWidth) / 2;
                        drawY = 0;
                    }
                    
                    // Use requestAnimationFrame for smooth rendering
                    requestAnimationFrame(() => {
                        // Clear canvas and draw the frame
                        this.ctx.fillStyle = '#000';
                        this.ctx.fillRect(0, 0, containerWidth, containerHeight);
                        this.ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                    });
                };
                img.src = frameData;
                this.lastFrameTime = Date.now();
            }

            handleStreamUpdate(data) {
                if (data && data.streamId === 'active') {
                    if (!this.isStreaming) {
                        this.updateStatus('waiting', 'Waiting for frames...');
                    }
                }
            }

            handleStreamStopped() {
                this.isStreaming = false;
                this.frameBuffer = [];
                if (this.playbackInterval) {
                    clearInterval(this.playbackInterval);
                    this.playbackInterval = null;
                }
                this.embedContainer.classList.remove('streaming');
                this.videoPlaceholder.style.display = 'flex';
                this.viewVideo.style.display = 'none';
                this.canvas.style.display = 'none';
                this.updateStatus('waiting', 'Stream stopped. Waiting for new stream...');
            }

            handleStreamPaused() {
                this.updateStatus('waiting', 'Stream paused...');
            }

            handleStreamResumed() {
                if (this.isStreaming) {
                    this.updateStatus('connected', 'Connected - Streaming live');
                } else {
                    this.updateStatus('waiting', 'Stream resumed. Waiting for frames...');
                }
            }

            updateStatus(status, text) {
                this.statusText.innerHTML = text;
                if (status === 'connected') {
                    this.statusText.innerHTML = text + '<span class="live-badge">LIVE</span>';
                }
                this.statusIndicator.className = `status-indicator ${status}`;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const viewer = new VideoViewer();
        });
    </script>
</body>
</html>

